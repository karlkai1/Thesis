Overview
This script solves the Vehicle Routing Problem (VRP) using Google OR-Tools and automatically detects and splits routes that contain impossible road connections, ensuring all generated routes are physically feasible in the SUMO network.
What It Does

Loads Clean Distance Matrix:

Reads preprocessed distance matrix (distance_matrix_clean.npy)
Loads corresponding node IDs (node_ids_clean.txt)
Keeps original matrix copy to identify impossible connections (infinity values)
Converts distances to integers and replaces infinity with large sentinel value (99999999) for OR-Tools compatibility


Creates VRP Data Model:

Configures problem parameters:

Number of vehicles (default: 15)
Vehicle capacity (default: 100 deliveries per vehicle)
Depot location (index 0)
Demand per delivery point (1 unit each)


Prepares data structure for OR-Tools solver


Solves VRP Using OR-Tools:

Initial solution strategy: PATH_CHEAPEST_ARC (greedy nearest-neighbor approach)
Optimization: Guided Local Search metaheuristic for route improvement
Objective: Minimize total distance traveled
Constraints:

All deliveries must be served
Vehicle capacity limits respected
All routes start and end at depot


Time limit: Configurable (default: 10 seconds)


Validates Route Feasibility:

After optimization, checks each route for impossible consecutive connections
Identifies segments where distance is infinity in original matrix
These represent one-way streets, disconnected areas, or routing failures


Automatically Splits Problematic Routes:
When impossible connections are detected:

Identifies split points: Locations where consecutive stops cannot connect
Creates sub-routes: Breaks original route into valid segments
Ensures depot connectivity: Each sub-route starts and ends at depot
Preserves deliveries: All stops retained across sub-routes
Tracks lineage: Labels sub-routes as parts of original vehicle


Generates Solution Data:

Route information: Node sequence, distances, delivery counts
Validation flags: Identifies partial/split routes
Statistics: Total vehicles used, deliveries covered, distance traveled
Metadata: Original route count, number of splits performed


Saves Results in Multiple Formats:

JSON (.json): Human-readable, structured solution data
Pickle (.pkl): Python-native format for fast loading in subsequent steps


Key Functions
load_distance_matrix()
Loads and prepares distance matrix for optimization
check_route_validity()
Scans route for impossible consecutive connections using original matrix
split_route_at_invalid_segments()
Intelligently breaks problematic routes into feasible sub-routes
create_data_model()
Sets up VRP problem configuration
solve_vrp()
Runs OR-Tools optimization with specified time limit
extract_solution()
Extracts routes, validates feasibility, and performs automatic splitting
save_solution()
Exports solution data in JSON and pickle formats
Input Requirements

distance_matrix_clean.npy - NumPy distance matrix (meters)
node_ids_clean.txt - Ordered list of node identifiers

Output Files

vrp_solution_split.json - Human-readable solution
vrp_solution_split.pkl - Python pickle for programmatic use

Configuration Parameters

num_vehicles: Number of delivery vehicles (default: 15)
vehicle_capacity: Max deliveries per vehicle (default: 100)
time_limit_seconds: Optimization time limit (default: 10)
MAX_DISTANCE: Sentinel value for impossible routes (99999999)

Solution Structure
json{
  "routes": [
    {
      "vehicle_id": 0,
      "route": [0, 45, 123, 67, 0],
      "route_ids": ["depot", "point_45", "point_123", "point_67", "depot"],
      "distance": 15234,
      "deliveries": 3
    }
  ],
  "num_vehicles_used": 15,
  "num_original_routes": 12,
  "routes_with_issues": 2,
  "total_deliveries": 287,
  "total_distance": 234567,
  "node_ids": ["depot", "point_1", ...]
}
Route Splitting Example
Original route (impossible):
depot → point_45 → point_123 (❌ impossible) → point_67 → depot
After splitting:
Vehicle 5_part0: depot → point_45 → depot (2 deliveries)
Vehicle 5_part1: depot → point_123 → point_67 → depot (2 deliveries)
Statistics Reported

Initial routes generated by solver
Routes requiring splitting
Final route count after splitting
Total deliveries covered
Total distance traveled
Details of all split operations


Dependencies

numpy - Matrix operations
ortools - Google OR-Tools VRP solver
json - JSON export
pickle - Binary serialization
time - Performance tracking

Optimization Strategy

First Solution: Quickly find initial feasible solution using cheapest arc insertion
Local Search: Improve solution through guided local search metaheuristic
Validation: Check for impossible connections in optimized routes
Correction: Split problematic routes to ensure physical feasibility

Why Route Splitting?
OR-Tools optimizes mathematically but doesn't know about real-world routing impossibilities (one-way streets, disconnected areas). This script bridges that gap by:

Letting OR-Tools find optimal mathematical solutions
Post-processing to ensure physical feasibility
Preserving as much of the optimization as possible while fixing impossible connections

Next Steps (as shown in output)

Use vrp_solution_split.pkl for route generation
Routes are pre-validated and split
All routes guaranteed to work in duarouter

Note
This approach ensures 100% routing success by catching and fixing impossible connections before attempting to generate actual SUMO routes, preventing duarouter failures downstream.
